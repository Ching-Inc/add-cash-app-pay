<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script
    type="text/javascript"
    src="https://sandbox.web.squarecdn.com/v1/square.js">
  </script>
  <script>
    let appId = '';
    let locationId = '';

    function setCreds(applicationId, location){
      appId = applicationId;
      locationId = location;
      Print.postMessage(applicationId + " " + location)
    }

    function buildPaymentRequest(payments) {
      const paymentRequest = payments.paymentRequest({
        countryCode: 'US',
        currencyCode: 'USD',
        total: {
          amount: '1.00',
          label: 'Total',
        },
      });
      return paymentRequest;
    }

    async function initializeCashApp(payments) {
      const paymentRequest = buildPaymentRequest(payments);
      const cashAppPay = await payments.cashAppPay(paymentRequest, {
        redirectURL: 'https://chingpay.app',
        referenceId: 'my-website-00000001',
      });
      const buttonOptions = {
        shape: 'semiround',
        width: 'full',
      };
      await cashAppPay.attach('#cash-app-pay', buttonOptions);
      return cashAppPay;
    }

    async function createPayment(token) {
      console.log("sending payment")
      const body = JSON.stringify({
        locationId,
        sourceId: token,
        "amount": {
          "value": "1.00",
          "currency" : "USD"
        },
        "cashAppPayToken": token,
        "cashAppUniqueKey" : "123456"
      });

      const paymentResponse = await fetch('https://ching-partnership.herokuapp.com/v1/cashApp', {
        // mode: 'no-cors',
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body,
      });

      if (paymentResponse.ok) {
        return paymentResponse.json();
      }

      const errorBody = await paymentResponse.text();
      throw new Error(errorBody);
    }

    // status is either SUCCESS or FAILURE;
    function displayPaymentResults(status) {
      const statusContainer = document.getElementById(
        'payment-status-container'
      );
      if (status === 'SUCCESS') {
        statusContainer.classList.remove('is-failure');
        statusContainer.classList.add('is-success');
      } else {
        statusContainer.classList.remove('is-success');
        statusContainer.classList.add('is-failure');
      }

      statusContainer.style.visibility = 'visible';
    }

    async function getCred(){
      const response = await fetch("https://ching-partnership.herokuapp.com/v1/cashAppCred",{
          // mode: 'no-cors',
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        }
      ).then(data => {
        return data.json();
      });
      console.log("this is response" + response);
      appId = response['appId'];
      locationId = response['locationId'];
      return true;
    }

    document.addEventListener('DOMContentLoaded', async function () {
      console.log("this is square " + !window.Square)
      if (!window.Square) {
        console.log("cant load square");
        throw new Error('Square.js failed to load properly');
      }

      let payments;
      try {
        // var boo = await getCred();
        // console.log("this is "+ boo)
        while (appId.length === 0 && locationId.length === 0) {
          // do nothing
        }
        console.log("showing button option " + appId + "  " + locationId);
        payments = window.Square.payments(appId, locationId);
        console.log("showing completed " + appId + "  " + locationId);
      } catch {
        const statusContainer = document.getElementById(
          'payment-status-container'
        );
        statusContainer.className = 'missing-credentials';
        statusContainer.style.visibility = 'visible';
        return;
      }

      let cashAppPay;
      try {
        console.log("showing cashAppPay " + appId + "  " + locationId);
        cashAppPay = await initializeCashApp(payments);
      } catch (e) {
        console.error('Initializing Cash App Pay failed', e);
      }
      if (cashAppPay) {
        console.log("addEventlistener cashAppPay " + appId + "  " + locationId);
        cashAppPay.addEventListener(
          'ontokenization',
          async function ({ detail }) {
            console.log("calling cashAppPay ");
            const tokenResult = detail.tokenResult;
            if (tokenResult.status === 'OK') {
              const paymentResults = await createPayment(tokenResult.token);

              displayPaymentResults('SUCCESS');
              console.debug('Payment Success', paymentResults);
            } else {
              let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;

              if (tokenResult.errors) {
                errorMessage += ` and errors: ${JSON.stringify(
                  tokenResult.errors
                )}`;
              }
              displayPaymentResults('FAILURE');
              throw new Error(errorMessage);
            }
          }
        );
      }
    });
  </script>
</head>
<body>

<form id="payment-form">
  <h2>Pay $1.00</h2>
  <div id="cash-app-pay"></div>
</form>
<div id="payment-status-container"></div>

</body>
</html>
